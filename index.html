<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for PWA -->
    <meta name="theme-color" content="#111827"/>
    <title>AI Workout Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .touch-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .celebration {
            animation: celebration 0.8s ease-in-out;
        }
        @keyframes celebration {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { transform: scale(1.3) rotate(5deg); }
            75% { transform: scale(1.2) rotate(-5deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen antialiased">

    <!-- Main Content -->
    <main class="flex-grow overflow-y-auto pb-20">
        <!-- Today Screen -->
        <div id="today-screen" class="p-6 space-y-6">
            <header>
                <h1 class="text-3xl font-bold tracking-tight">Hello!</h1>
                <p class="text-gray-400" id="current-date">Let's get stronger today.</p>
            </header>

            <div id="workout-card" class="bg-gray-800 rounded-2xl p-6 space-y-4 shadow-lg fade-in">
                 <div class="flex items-center space-x-4">
                    <div id="workout-icon" class="bg-blue-600 p-3 rounded-full">
                        <!-- Icon will be inserted here -->
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Today's Focus</p>
                        <h2 id="workout-title" class="text-2xl font-bold">Workout A</h2>
                        <p id="workout-subtitle" class="text-gray-300">Push & Squat Focus</p>
                    </div>
                </div>
                <button id="start-workout-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-lg touch-active transition-all duration-200 hover:bg-blue-700">
                    Start Workout
                </button>
            </div>
            
            <div id="rest-day-card" class="bg-gray-800 rounded-2xl p-6 text-center space-y-3 shadow-lg hidden fade-in">
                <div class="flex justify-center">
                    <div class="bg-green-600 p-3 rounded-full">
                        <i data-lucide="bed-double"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold">Rest Day</h2>
                <p class="text-gray-300">Your muscles grow when you rest. Stay hydrated and eat well.</p>
            </div>

            <!-- Stats Card -->
            <div class="bg-gray-800 rounded-2xl p-5 shadow-lg space-y-3 fade-in">
                <h3 class="font-bold text-lg">Your Progress</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center">
                        <p class="text-3xl font-bold text-blue-400" id="workout-streak">0</p>
                        <p class="text-xs text-gray-400">Day Streak</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-green-400" id="total-workouts">0</p>
                        <p class="text-xs text-gray-400">Workouts</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-purple-400" id="this-week">0</p>
                        <p class="text-xs text-gray-400">This Week</p>
                    </div>
                </div>
            </div>

            <!-- Motivational Quote -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-5 shadow-lg fade-in">
                <p class="text-white text-center italic" id="motivational-quote">"Discipline is choosing between what you want now and what you want most."</p>
            </div>

            <div class="bg-gray-800 rounded-2xl p-5 shadow-lg space-y-3 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">Workout Reminders</h3>
                        <p class="text-gray-400 text-sm">Get a nudge at 8:00 PM.</p>
                    </div>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="reminder-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="reminder-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-600 cursor-pointer"></label>
                    </div>
                    <style>.toggle-checkbox:checked { right: 0; border-color: #2563EB; } .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }</style>
                </div>
            </div>
        </div>

        <!-- Workout Screen -->
        <div id="workout-screen" class="hidden p-6 space-y-4">
            <div class="flex items-center justify-between mb-2">
                <button id="back-to-home-btn" class="text-gray-400 hover:text-white touch-active">
                    <i data-lucide="arrow-left"></i>
                </button>
                <p id="progress-text" class="text-gray-400 font-medium">1 / 8</p>
            </div>
            <div class="flex items-center justify-between">
                <h2 id="current-exercise-title" class="text-2xl font-bold">Goblet Squats</h2>
                <button id="exercise-info-btn" class="text-blue-400 touch-active">
                    <i data-lucide="info"></i>
                </button>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-inner" style="width: 10%"></div>
            </div>

            <div class="text-center bg-gray-800 rounded-2xl p-8 my-4 fade-in">
                <div id="exercise-tip" class="bg-blue-900 bg-opacity-30 rounded-lg p-3 mb-4 text-sm text-blue-200 hidden">
                    <p id="exercise-tip-text"></p>
                </div>
                <p class="text-gray-400 text-lg">Current Set</p>
                <p id="current-set" class="text-7xl font-extrabold my-2">1 / 3</p>
                <p id="current-reps" class="text-blue-400 text-xl font-semibold">8 - 12 Reps</p>
            </div>

            <button id="complete-set-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-lg touch-active transition-all duration-200">Complete Set</button>

            <div id="rest-timer-view" class="hidden text-center fade-in">
                <p class="text-lg text-green-400 font-bold">REST</p>
                <p id="rest-timer" class="text-6xl font-extrabold my-2">60</p>
                <div class="flex justify-center gap-3 mt-3">
                    <button id="skip-rest-btn" class="bg-gray-700 text-white px-6 py-2 rounded-lg touch-active transition-all duration-200">Skip</button>
                    <button id="add-time-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg touch-active transition-all duration-200">+15s</button>
                </div>
            </div>
            
            <button id="next-exercise-btn" class="w-full bg-gray-700 text-white font-bold py-3 rounded-xl text-md touch-active transition-all duration-200 mt-4 hidden">Next Exercise</button>
            <button id="finish-workout-btn" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl text-lg touch-active transition-all duration-200 hidden mt-4">Finish Workout</button>
        </div>
        
        <!-- Workout Complete Screen -->
        <div id="workout-complete-screen" class="hidden p-8 flex flex-col items-center justify-center text-center space-y-4 h-full">
            <div class="celebration">
                <i data-lucide="trophy" class="text-yellow-400" size="80"></i>
            </div>
            <h2 class="text-4xl font-bold">Workout Complete!</h2>
            <p class="text-gray-300 max-w-sm">Amazing work. You've pushed your limits. Now remember to refuel with protein and get a good night's sleep.</p>
            <div class="bg-gray-800 rounded-xl p-4 max-w-sm w-full mt-4">
                <p class="text-sm text-gray-400 mb-2">Session Summary</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <p class="text-2xl font-bold text-blue-400" id="session-exercises">8</p>
                        <p class="text-xs text-gray-400">Exercises</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-400" id="session-sets">24</p>
                        <p class="text-xs text-gray-400">Sets</p>
                    </div>
                </div>
            </div>
            <button id="go-home-btn" class="w-full max-w-sm bg-blue-600 text-white font-bold py-4 rounded-xl text-lg touch-active transition-all duration-200 mt-6">Back to Home</button>
        </div>


        <!-- HIIT Timer Screen -->
        <div id="hiit-screen" class="hidden p-6 flex flex-col justify-between h-full">
            <div class="text-center">
                <h2 class="text-2xl font-bold">HIIT Finisher</h2>
                <p class="text-gray-400">15 Minutes to incinerate fat.</p>
            </div>
            <div id="hiit-timer-display" class="flex flex-col items-center justify-center flex-grow transition-colors duration-500 rounded-2xl bg-gray-800">
                 <p id="hiit-status" class="text-3xl font-bold tracking-widest uppercase text-gray-400">GET READY</p>
                 <p id="hiit-timer" class="text-9xl font-extrabold my-2">10</p>
                 <p id="hiit-round" class="text-lg text-gray-300">Round 1 / 10</p>
            </div>
            <div class="grid grid-cols-3 gap-4 pt-6">
                <button id="hiit-reset-btn" class="bg-gray-700 p-4 rounded-2xl flex justify-center items-center touch-active"><i data-lucide="rotate-cw"></i></button>
                <button id="hiit-start-pause-btn" class="bg-blue-600 col-span-2 p-4 rounded-2xl flex justify-center items-center touch-active text-lg font-bold space-x-2">
                    <i data-lucide="play"></i>
                    <span>Start</span>
                </button>
            </div>
        </div>

        <!-- Diet Screen -->
        <div id="diet-screen" class="hidden p-6 space-y-4">
            <h2 class="text-2xl font-bold">Diet Protocol</h2>
            <p class="text-gray-400">Your diet is fixed, but your discipline isn't. Control what you can control.</p>
            
            <div class="space-y-3">
                <div class="bg-gray-800 p-4 rounded-lg flex items-start space-x-4">
                    <i data-lucide="hand" class="text-blue-400 mt-1 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-semibold">Portion Control is #1</h3>
                        <p class="text-gray-300 text-sm">Rice: 1 clenched fist. Veggies: Half your plate. Protein: Palm of your hand.</p>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg flex items-start space-x-4">
                    <i data-lucide="egg" class="text-yellow-400 mt-1 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-semibold">Prioritize Protein</h3>
                        <p class="text-gray-300 text-sm">Eat your chicken/eggs first. Have 2-3 eggs for breakfast daily. Consider a post-workout whey protein shake.</p>
                    </div>
                </div>
                 <div class="bg-gray-800 p-4 rounded-lg flex items-start space-x-4">
                    <i data-lucide="glass-water" class="text-cyan-400 mt-1 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-semibold">Hydrate Aggressively</h3>
                        <p class="text-gray-300 text-sm">Drink a large glass of water before each meal. Aim for 2-3 liters per day.</p>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg flex items-start space-x-4">
                    <i data-lucide="zap-off" class="text-red-400 mt-1 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-semibold">Minimize Sauces & Oils</h3>
                        <p class="text-gray-300 text-sm">Be mindful of hidden calories. If possible, ask for less sauce or drain excess oil.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="hidden p-6 space-y-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">Workout History</h2>
                <button id="clear-history-btn" class="text-red-400 text-sm touch-active">
                    <i data-lucide="trash-2" class="inline-block w-4 h-4"></i> Clear
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-gray-800 rounded-xl p-4 text-center">
                    <p class="text-2xl font-bold text-blue-400" id="history-streak">0</p>
                    <p class="text-xs text-gray-400 mt-1">Current Streak</p>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 text-center">
                    <p class="text-2xl font-bold text-green-400" id="history-total">0</p>
                    <p class="text-xs text-gray-400 mt-1">Total</p>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 text-center">
                    <p class="text-2xl font-bold text-purple-400" id="history-month">0</p>
                    <p class="text-xs text-gray-400 mt-1">This Month</p>
                </div>
            </div>

            <div id="workout-history-list" class="space-y-3">
                <!-- History items will be inserted here -->
            </div>
            
            <div id="empty-history" class="text-center py-12 hidden">
                <i data-lucide="calendar-x" class="mx-auto text-gray-600 mb-3"></i>
                <p class="text-gray-400">No workouts yet. Start your first one today!</p>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around">
        <button data-screen="today-screen" class="nav-btn flex-1 p-3 text-center text-blue-500">
            <i data-lucide="home"></i>
            <span class="text-xs block">Today</span>
        </button>
        <button data-screen="hiit-screen" class="nav-btn flex-1 p-3 text-center text-gray-400">
            <i data-lucide="timer"></i>
            <span class="text-xs block">HIIT Timer</span>
        </button>
        <button data-screen="diet-screen" class="nav-btn flex-1 p-3 text-center text-gray-400">
            <i data-lucide="utensils-crossed"></i>
            <span class="text-xs block">Diet</span>
        </button>
        <button data-screen="history-screen" class="nav-btn flex-1 p-3 text-center text-gray-400">
            <i data-lucide="calendar-clock"></i>
            <span class="text-xs block">History</span>
        </button>
    </nav>
    
    <script>
        // Register the service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // --- All the application JavaScript from the previous step goes here ---
        // (The JS code is identical to the previous version, just the sw.js path is changed above)
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const WORKOUTS = {
                A: { 
                    title: "Workout A", 
                    subtitle: "Push & Squat Focus", 
                    icon: "barbell", 
                    exercises: [
                        { name: "Goblet Squats", sets: 3, reps: "8-12", tip: "Keep chest up, core tight. Drive through heels." }, 
                        { name: "Dumbbell Bench Press", sets: 3, reps: "8-12", tip: "Control the descent. Push explosively up." }, 
                        { name: "Overhead Press", sets: 3, reps: "8-12", tip: "Engage core. Press weight straight overhead." }, 
                        { name: "Lunges", sets: 3, reps: "10-12 per leg", tip: "Keep torso upright. Back knee nearly touches ground." }, 
                        { name: "Tricep Pushdowns", sets: 2, reps: "12-15", tip: "Keep elbows locked at sides. Full extension." }
                    ], 
                    core: [
                        { name: "Plank", sets: 3, reps: "45-60 sec", tip: "Body in straight line. Don't let hips sag." }, 
                        { name: "Lying Leg Raises", sets: 3, reps: "15-20", tip: "Keep lower back pressed to floor. Controlled movement." }, 
                        { name: "Russian Twists", sets: 3, reps: "20 total", tip: "Twist from core, not arms. Keep feet elevated." }
                    ] 
                },
                B: { 
                    title: "Workout B", 
                    subtitle: "Pull & Hinge Focus", 
                    icon: "move-up", 
                    exercises: [
                        { name: "Romanian Deadlifts", sets: 3, reps: "8-12", tip: "Hinge at hips. Keep back straight and core tight." }, 
                        { name: "Lat Pulldowns", sets: 3, reps: "8-12", tip: "Pull to upper chest. Squeeze shoulder blades together." }, 
                        { name: "Bent-Over Rows", sets: 3, reps: "10-12 per arm", tip: "Pull elbow back. Keep core engaged throughout." }, 
                        { name: "Leg Press", sets: 3, reps: "10-15", tip: "Full range of motion. Don't lock knees at top." }, 
                        { name: "Bicep Curls", sets: 2, reps: "12-15", tip: "No swinging. Full contraction at top." }
                    ], 
                    core: [
                        { name: "Plank", sets: 3, reps: "45-60 sec", tip: "Body in straight line. Don't let hips sag." }, 
                        { name: "Lying Leg Raises", sets: 3, reps: "15-20", tip: "Keep lower back pressed to floor. Controlled movement." }, 
                        { name: "Russian Twists", sets: 3, reps: "20 total", tip: "Twist from core, not arms. Keep feet elevated." }
                    ] 
                }
            };

            const MOTIVATIONAL_QUOTES = [
                "Discipline is choosing between what you want now and what you want most.",
                "The only bad workout is the one that didn't happen.",
                "Your body can stand almost anything. It's your mind you have to convince.",
                "Strength doesn't come from what you can do. It comes from overcoming what you couldn't.",
                "The pain you feel today will be the strength you feel tomorrow.",
                "Don't count the days, make the days count.",
                "Success isn't given. It's earned. On the track, on the field, in the gym.",
                "The difference between try and triumph is a little umph.",
                "Push yourself because no one else is going to do it for you.",
                "Great things never come from comfort zones."
            ];

            let state = { 
                currentScreen: 'today-screen', 
                lastWorkoutType: localStorage.getItem('lastWorkoutType') || 'B', 
                lastWorkoutDate: localStorage.getItem('lastWorkoutDate') || '', 
                todaysWorkout: null, 
                workoutInProgress: false, 
                currentExerciseIndex: 0, 
                currentSet: 1, 
                restTimerInterval: null,
                restTimeLeft: 60,
                remindersEnabled: JSON.parse(localStorage.getItem('remindersEnabled')) || false,
                workoutHistory: JSON.parse(localStorage.getItem('workoutHistory')) || [],
                showExerciseTip: false
            };
            let hiitState = { timer: null, running: false, mode: 'prep', timeLeft: 10, totalRounds: 10, currentRound: 1, sprintDuration: 30, restDuration: 60, prepDuration: 10 };
            
            const screens = document.querySelectorAll('main > div');
            const navBtns = document.querySelectorAll('.nav-btn');
            const goHomeBtn = document.getElementById('go-home-btn');
            const currentDateEl = document.getElementById('current-date');
            const workoutCard = document.getElementById('workout-card');
            const restDayCard = document.getElementById('rest-day-card');
            const workoutTitle = document.getElementById('workout-title');
            const workoutSubtitle = document.getElementById('workout-subtitle');
            const workoutIconContainer = document.getElementById('workout-icon');
            const startWorkoutBtn = document.getElementById('start-workout-btn');
            const reminderToggle = document.getElementById('reminder-toggle');
            const currentExerciseTitle = document.getElementById('current-exercise-title');
            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const currentSetEl = document.getElementById('current-set');
            const currentRepsEl = document.getElementById('current-reps');
            const completeSetBtn = document.getElementById('complete-set-btn');
            const restTimerView = document.getElementById('rest-timer-view');
            const restTimerEl = document.getElementById('rest-timer');
            const skipRestBtn = document.getElementById('skip-rest-btn');
            const nextExerciseBtn = document.getElementById('next-exercise-btn');
            const finishWorkoutBtn = document.getElementById('finish-workout-btn');
            const hiitTimerDisplay = document.getElementById('hiit-timer-display');
            const hiitStatusEl = document.getElementById('hiit-status');
            const hiitTimerEl = document.getElementById('hiit-timer');
            const hiitRoundEl = document.getElementById('hiit-round');
            const hiitStartPauseBtn = document.getElementById('hiit-start-pause-btn');
            const hiitResetBtn = document.getElementById('hiit-reset-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');
            const exerciseInfoBtn = document.getElementById('exercise-info-btn');
            const exerciseTip = document.getElementById('exercise-tip');
            const exerciseTipText = document.getElementById('exercise-tip-text');
            const motivationalQuote = document.getElementById('motivational-quote');
            const workoutStreakEl = document.getElementById('workout-streak');
            const totalWorkoutsEl = document.getElementById('total-workouts');
            const thisWeekEl = document.getElementById('this-week');
            const historyStreakEl = document.getElementById('history-streak');
            const historyTotalEl = document.getElementById('history-total');
            const historyMonthEl = document.getElementById('history-month');
            const workoutHistoryList = document.getElementById('workout-history-list');
            const emptyHistory = document.getElementById('empty-history');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const addTimeBtn = document.getElementById('add-time-btn');
            const sessionExercisesEl = document.getElementById('session-exercises');
            const sessionSetsEl = document.getElementById('session-sets');
            
            function determineTodaysWorkout() {
                const today = new Date().toISOString().slice(0, 10);
                const todayDay = new Date().getDay();
                if (state.lastWorkoutDate === today) return null;
                const isWorkoutDay = [1, 3, 5].includes(todayDay);
                if (!isWorkoutDay) return null;
                const nextType = state.lastWorkoutType === 'A' ? 'B' : 'A';
                return WORKOUTS[nextType];
            }

            function showScreen(screenId) {
                screens.forEach(screen => screen.classList.toggle('hidden', screen.id !== screenId));
                navBtns.forEach(btn => {
                    const isActive = btn.dataset.screen === screenId;
                    btn.classList.toggle('text-blue-500', isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                });
                state.currentScreen = screenId;
                
                // Refresh history when viewing history screen
                if (screenId === 'history-screen') {
                    calculateStats();
                    renderHistory();
                }
            }

            function startWorkout() {
                state.workoutInProgress = true;
                state.currentExerciseIndex = 0;
                state.currentSet = 1;
                renderCurrentExercise();
                showScreen('workout-screen');
            }

            function renderCurrentExercise() {
                const workout = state.todaysWorkout;
                const fullWorkoutList = [...workout.exercises, ...workout.core];
                if (state.currentExerciseIndex >= fullWorkoutList.length) {
                    finishWorkout();
                    return;
                }
                const exercise = fullWorkoutList[state.currentExerciseIndex];
                const isCore = state.currentExerciseIndex >= workout.exercises.length;
                currentExerciseTitle.textContent = exercise.name + (isCore ? " (Core)" : "");
                currentRepsEl.textContent = `${exercise.reps} Reps`;
                currentSetEl.textContent = `${state.currentSet} / ${exercise.sets}`;
                const progress = (state.currentExerciseIndex + 1) / fullWorkoutList.length;
                progressBar.style.width = `${progress * 100}%`;
                progressText.textContent = `${state.currentExerciseIndex + 1} / ${fullWorkoutList.length}`;
                completeSetBtn.classList.remove('hidden');
                restTimerView.classList.add('hidden');
                nextExerciseBtn.classList.add('hidden');
                finishWorkoutBtn.classList.add('hidden');
                
                // Show/hide exercise tip
                if (state.showExerciseTip && exercise.tip) {
                    exerciseTip.classList.remove('hidden');
                    exerciseTipText.textContent = exercise.tip;
                } else {
                    exerciseTip.classList.add('hidden');
                }
            }

            function handleCompleteSet() {
                const workout = state.todaysWorkout;
                const fullWorkoutList = [...workout.exercises, ...workout.core];
                const exercise = fullWorkoutList[state.currentExerciseIndex];
                
                // Visual feedback
                completeSetBtn.classList.add('shake');
                setTimeout(() => completeSetBtn.classList.remove('shake'), 500);
                
                if (state.currentSet < exercise.sets) {
                    state.currentSet++;
                    startRestTimer();
                } else {
                    if (state.currentExerciseIndex < fullWorkoutList.length - 1) {
                        nextExerciseBtn.classList.remove('hidden');
                    } else {
                        finishWorkoutBtn.classList.remove('hidden');
                    }
                    completeSetBtn.classList.add('hidden');
                }
            }

            function handleNextExercise() {
                state.currentExerciseIndex++;
                state.currentSet = 1;
                renderCurrentExercise();
            }

            function startRestTimer(duration = 60) {
                completeSetBtn.classList.add('hidden');
                restTimerView.classList.remove('hidden');
                state.restTimeLeft = duration;
                restTimerEl.textContent = state.restTimeLeft;
                clearInterval(state.restTimerInterval);
                state.restTimerInterval = setInterval(() => {
                    state.restTimeLeft--;
                    restTimerEl.textContent = state.restTimeLeft;
                    if (state.restTimeLeft <= 0) {
                        clearInterval(state.restTimerInterval);
                        restTimerView.classList.add('hidden');
                        renderCurrentExercise();
                    }
                }, 1000);
            }

            function addRestTime() {
                state.restTimeLeft += 15;
                restTimerEl.textContent = state.restTimeLeft;
                addTimeBtn.classList.add('pulse');
                setTimeout(() => addTimeBtn.classList.remove('pulse'), 500);
            }

            function skipRest() {
                clearInterval(state.restTimerInterval);
                restTimerView.classList.add('hidden');
                renderCurrentExercise();
            }

            function finishWorkout() {
                state.workoutInProgress = false;
                state.lastWorkoutType = state.todaysWorkout === WORKOUTS.A ? 'A' : 'B';
                state.lastWorkoutDate = new Date().toISOString().slice(0, 10);
                localStorage.setItem('lastWorkoutType', state.lastWorkoutType);
                localStorage.setItem('lastWorkoutDate', state.lastWorkoutDate);
                
                // Calculate session stats
                const workout = state.todaysWorkout;
                const totalExercises = workout.exercises.length + workout.core.length;
                const totalSets = [...workout.exercises, ...workout.core].reduce((sum, ex) => sum + ex.sets, 0);
                sessionExercisesEl.textContent = totalExercises;
                sessionSetsEl.textContent = totalSets;
                
                // Save workout to history
                state.workoutHistory.push({
                    type: state.lastWorkoutType,
                    date: state.lastWorkoutDate,
                    timestamp: new Date().getTime()
                });
                localStorage.setItem('workoutHistory', JSON.stringify(state.workoutHistory));
                
                showScreen('workout-complete-screen');
            }

            function setupReminders() {
                reminderToggle.checked = state.remindersEnabled;
            }

            function handleReminderToggle() {
                state.remindersEnabled = reminderToggle.checked;
                localStorage.setItem('remindersEnabled', state.remindersEnabled);
                if (state.remindersEnabled && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            }

            function scheduleReminder() {
                if (!state.remindersEnabled || Notification.permission !== 'granted' || !state.todaysWorkout) return;
                const now = new Date();
                const reminderTime = new Date();
                reminderTime.setHours(20, 0, 0, 0); // 8:00 PM
                if (now < reminderTime) {
                    const timeout = reminderTime.getTime() - now.getTime();
                    setTimeout(() => { new Notification("Time to Train!", { body: `Let's crush ${state.todaysWorkout.title} today. You've got this!` }); }, timeout);
                }
            }

            function updateHiitUI() {
                hiitTimerEl.textContent = hiitState.timeLeft;
                hiitRoundEl.textContent = `Round ${hiitState.currentRound} / ${hiitState.totalRounds}`;
                hiitStartPauseBtn.innerHTML = hiitState.running ? `<i data-lucide="pause"></i><span>Pause</span>` : `<i data-lucide="play"></i><span>Start</span>`;
                lucide.createIcons();
                let colorClass = 'bg-gray-800';
                if (hiitState.mode === 'sprint') colorClass = 'bg-red-800';
                if (hiitState.mode === 'rest') colorClass = 'bg-green-800';
                hiitTimerDisplay.className = `flex flex-col items-center justify-center flex-grow transition-colors duration-500 rounded-2xl ${colorClass}`;
                hiitStatusEl.textContent = hiitState.mode === 'prep' ? 'GET READY' : hiitState.mode.toUpperCase() + '!';
            }

            function playBeep(count = 1) {
                // Simple audio feedback using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = count > 1 ? 880 : 440;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.1);
                    }, i * 150);
                }
            }

            function hiitTick() {
                hiitState.timeLeft--;
                
                // Sound notifications
                if (hiitState.timeLeft === 3) {
                    playBeep(1);
                    hiitTimerEl.classList.add('pulse');
                } else if (hiitState.timeLeft === 0) {
                    playBeep(2);
                    hiitTimerEl.classList.remove('pulse');
                }
                
                if (hiitState.timeLeft < 0) {
                    switch(hiitState.mode) {
                        case 'prep': hiitState.mode = 'sprint'; hiitState.timeLeft = hiitState.sprintDuration; break;
                        case 'sprint': hiitState.mode = 'rest'; hiitState.timeLeft = hiitState.restDuration; break;
                        case 'rest':
                            hiitState.currentRound++;
                            if (hiitState.currentRound > hiitState.totalRounds) { 
                                playBeep(3);
                                resetHiit(); 
                                return; 
                            }
                            hiitState.mode = 'sprint'; hiitState.timeLeft = hiitState.sprintDuration; break;
                    }
                }
                updateHiitUI();
            }

            function toggleHiit() {
                hiitState.running = !hiitState.running;
                if (hiitState.running) {
                    hiitState.timer = setInterval(hiitTick, 1000);
                } else {
                    clearInterval(hiitState.timer);
                }
                updateHiitUI();
            }

            function resetHiit() {
                clearInterval(hiitState.timer);
                hiitState.running = false;
                hiitState.mode = 'prep';
                hiitState.timeLeft = hiitState.prepDuration;
                hiitState.currentRound = 1;
                updateHiitUI();
            }

            function calculateStats() {
                const now = new Date();
                const history = state.workoutHistory;
                
                // Total workouts
                const total = history.length;
                totalWorkoutsEl.textContent = total;
                if (historyTotalEl) historyTotalEl.textContent = total;
                
                // This week's workouts
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                const thisWeek = history.filter(w => new Date(w.date) >= startOfWeek).length;
                thisWeekEl.textContent = thisWeek;
                
                // This month's workouts
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const thisMonth = history.filter(w => new Date(w.date) >= startOfMonth).length;
                if (historyMonthEl) historyMonthEl.textContent = thisMonth;
                
                // Streak calculation
                let streak = 0;
                const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
                let checkDate = new Date();
                checkDate.setHours(0, 0, 0, 0);
                
                for (let i = 0; i < sortedHistory.length; i++) {
                    const workoutDate = new Date(sortedHistory[i].date);
                    workoutDate.setHours(0, 0, 0, 0);
                    
                    // Check if workout is on a valid workout day (M/W/F = 1/3/5)
                    while (checkDate.getDay() !== 1 && checkDate.getDay() !== 3 && checkDate.getDay() !== 5) {
                        checkDate.setDate(checkDate.getDate() - 1);
                    }
                    
                    if (workoutDate.getTime() === checkDate.getTime()) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 2); // Move to next potential workout day
                    } else {
                        break;
                    }
                }
                workoutStreakEl.textContent = streak;
                if (historyStreakEl) historyStreakEl.textContent = streak;
            }

            function renderHistory() {
                const history = state.workoutHistory;
                
                if (history.length === 0) {
                    emptyHistory.classList.remove('hidden');
                    workoutHistoryList.innerHTML = '';
                    return;
                }
                
                emptyHistory.classList.add('hidden');
                
                // Sort by date descending (newest first)
                const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                workoutHistoryList.innerHTML = sortedHistory.map((workout, index) => {
                    const date = new Date(workout.date);
                    const isToday = date.toISOString().slice(0, 10) === new Date().toISOString().slice(0, 10);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const workoutInfo = WORKOUTS[workout.type];
                    
                    return `
                        <div class="bg-gray-800 rounded-xl p-4 flex items-center justify-between fade-in">
                            <div class="flex items-center space-x-4">
                                <div class="bg-${workout.type === 'A' ? 'blue' : 'purple'}-600 p-3 rounded-lg">
                                    <i data-lucide="${workoutInfo.icon}" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold">${workoutInfo.title}${isToday ? ' ðŸ”¥' : ''}</h3>
                                    <p class="text-sm text-gray-400">${dayName}, ${dateStr}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">${workoutInfo.exercises.length + workoutInfo.core.length} exercises</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Reinitialize lucide icons after adding new HTML
                lucide.createIcons();
            }

            function clearHistory() {
                if (confirm('Are you sure you want to clear all workout history? This cannot be undone.')) {
                    state.workoutHistory = [];
                    localStorage.setItem('workoutHistory', JSON.stringify([]));
                    calculateStats();
                    renderHistory();
                }
            }

            function init() {
                currentDateEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                state.todaysWorkout = determineTodaysWorkout();
                
                // Display random motivational quote
                const randomQuote = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
                motivationalQuote.textContent = `"${randomQuote}"`;
                
                // Calculate and display stats
                calculateStats();
                
                if (state.todaysWorkout) {
                    workoutCard.classList.remove('hidden');
                    restDayCard.classList.add('hidden');
                    workoutTitle.textContent = state.todaysWorkout.title;
                    workoutSubtitle.textContent = state.todaysWorkout.subtitle;
                    workoutIconContainer.innerHTML = `<i data-lucide="${state.todaysWorkout.icon}"></i>`;
                    lucide.createIcons();
                } else {
                    workoutCard.classList.add('hidden');
                    restDayCard.classList.remove('hidden');
                }
                setupReminders();
                scheduleReminder();
                resetHiit();
                showScreen('today-screen');
            }

            function attachEventListeners() {
                navBtns.forEach(btn => btn.addEventListener('click', () => showScreen(btn.dataset.screen)));
                goHomeBtn.addEventListener('click', () => {
                    init();
                    showScreen('today-screen');
                });
                startWorkoutBtn.addEventListener('click', startWorkout);
                reminderToggle.addEventListener('change', handleReminderToggle);
                completeSetBtn.addEventListener('click', handleCompleteSet);
                nextExerciseBtn.addEventListener('click', handleNextExercise);
                finishWorkoutBtn.addEventListener('click', finishWorkout);
                skipRestBtn.addEventListener('click', skipRest);
                hiitStartPauseBtn.addEventListener('click', toggleHiit);
                hiitResetBtn.addEventListener('click', resetHiit);
                backToHomeBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to quit this workout?')) {
                        state.workoutInProgress = false;
                        init();
                        showScreen('today-screen');
                    }
                });
                exerciseInfoBtn.addEventListener('click', () => {
                    state.showExerciseTip = !state.showExerciseTip;
                    renderCurrentExercise();
                });
                clearHistoryBtn.addEventListener('click', clearHistory);
                addTimeBtn.addEventListener('click', addRestTime);
            }

            attachEventListeners();
            init();
        });
    </script>
</body>
</html>


